{% extends "base.html" %}

{% block title %}{{ site.site_name if site else 'Site' }} - Comment Widget Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/dashboard">Dashboard</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="/dashboard/sites">Sites</a>
                        </li>
                        <li class="breadcrumb-item active">
                            {{ site.site_name if site else 'Site Not Found' }}
                        </li>
                    </ol>
                </nav>
                {% if site %}
                <h1 class="h3 mb-0">{{ site.site_name }}</h1>
                <p class="text-muted">
                    <i class="fas fa-link"></i>
                    <a href="{{ site.site_url }}" target="_blank" class="text-decoration-none">{{ site.site_url }}</a>
                </p>
                {% else %}
                <h1 class="h3 mb-0">Site Not Found</h1>
                <p class="text-muted">The requested site could not be found.</p>
                {% endif %}
            </div>
            {% if site %}
            <div>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createThreadModal">
                    <i class="fas fa-plus"></i> Add Thread
                </button>
                <a href="/dashboard/sites" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Sites
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if site %}
<!-- Site Overview -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-list fa-2x text-primary mb-2"></i>
                <h4 class="mb-1">{{ threads|length }}</h4>
                <small class="text-muted">Threads</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-comments fa-2x text-success mb-2"></i>
                <h4 class="mb-1">{{ comments|length }}</h4>
                <small class="text-muted">Total Comments</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                <h4 class="mb-1">{{ comments|selectattr('is_approved', 'equalto', 0)|list|length }}</h4>
                <small class="text-muted">Pending Moderation</small>
            </div>
        </div>
    </div>
</div>

<!-- Threads Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i> Threads
                </h5>
                <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#createThreadModal">
                    <i class="fas fa-plus"></i> New Thread
                </button>
            </div>
            <div class="card-body">
                {% if threads %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>URL</th>
                                <th>Comments</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for thread in threads %}
                            <tr>
                                <td>
                                    <strong>{{ thread.title }}</strong>
                                    {% if 'Main Thread' in thread.title %}
                                    <span class="badge bg-primary ms-2">Main</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        <a href="{{ thread.url }}" target="_blank" class="text-decoration-none">
                                            {{ thread.url[:50] }}{% if thread.url|length > 50 %}...{% endif %}
                                        </a>
                                    </small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        {{ comments|selectattr('thread_referencia_id', 'equalto', thread.id)|list|length }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-success">Active</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewThreadComments({{ thread.id }})">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteThread({{ thread.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-list fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No threads found for this site</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Comments Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-comments"></i> Recent Comments
                </h5>
                <a href="/dashboard/comments" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-external-link-alt"></i> View All
                </a>
            </div>
            <div class="card-body">
                {% if comments %}
                <div class="list-group list-group-flush">
                    {% for comment in comments[:10] %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <strong class="me-2">{{ comment.author_name }}</strong>
                                    <small class="text-muted">{{ comment.created_at[:19].replace('T', ' ') }}</small>
                                    {% if comment.is_approved == 0 %}
                                    <span class="badge bg-warning ms-2">Pending</span>
                                    {% elif comment.is_approved == 1 %}
                                    <span class="badge bg-success ms-2">Approved</span>
                                    {% else %}
                                    <span class="badge bg-danger ms-2">Rejected</span>
                                    {% endif %}
                                </div>
                                <p class="mb-1 text-truncate">{{ comment.content }}</p>
                                <small class="text-muted">
                                    <i class="fas fa-list"></i> {{ comment.thread_title }}
                                </small>
                            </div>
                            <div class="ms-2">
                                {% if comment.is_approved == 0 %}
                                <form method="post" action="/dashboard/comments/{{ comment.id }}/moderate" class="d-inline">
                                    <input type="hidden" name="action" value="approve">
                                    <button type="submit" class="btn btn-sm btn-success" title="Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                <form method="post" action="/dashboard/comments/{{ comment.id }}/moderate" class="d-inline">
                                    <input type="hidden" name="action" value="reject">
                                    <button type="submit" class="btn btn-sm btn-danger" title="Reject">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No comments yet</p>
                    <small class="text-muted">Comments will appear here once users start interacting with your site</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Create Thread Modal -->
<div class="modal fade" id="createThreadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Add New Thread
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/dashboard/threads">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Thread Title</label>
                        <input type="text" class="form-control" id="title" name="title" required
                               placeholder="Article Title or Page Name" maxlength="200">
                        <div class="form-text">Give this thread a descriptive name</div>
                    </div>

                    <div class="mb-3">
                        <label for="url" class="form-label">Page URL</label>
                        <input type="url" class="form-control" id="url" name="url" required
                               value="{{ site.site_url }}" maxlength="500">
                        <div class="form-text">The specific page URL for this thread</div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> This will create a new comment thread for a specific page on your site.
                        The main thread is automatically created when you add a site.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Thread</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% else %}
<!-- Site Not Found -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-exclamation-triangle fa-4x text-warning mb-4"></i>
                <h4 class="text-muted">Site Not Found</h4>
                <p class="text-muted">The site you're looking for doesn't exist or you don't have permission to view it.</p>
                <a href="/dashboard/sites" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Back to Sites
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function viewThreadComments(threadId) {
    // For now, just show an alert. In a full implementation, this could open a modal or redirect
    alert('Thread comments view not yet implemented. Thread ID: ' + threadId);
}

function deleteThread(threadId) {
    if (confirm('Are you sure you want to delete this thread? All comments will be lost.')) {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/dashboard/threads/${threadId}/delete`;

        // Add CSRF token if needed
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = 'dummy'; // In a real app, you'd get this from the server
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }
}

// Auto-focus first input in modal
document.getElementById('createThreadModal')?.addEventListener('shown.bs.modal', function () {
    document.getElementById('title').focus();
});
</script>
{% endblock %}